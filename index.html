<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Monitor de Signos Vitales en Tiempo Real</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <!-- Indicador de conexiÃ³n -->
  <div id="connection-status" class="connection-status">â³ Conectando...</div>

  <div class="contenedor">
    <!-- Header -->
    <div class="header">
      <h1>ğŸ¥ Monitor de Signos Vitales</h1>
      <p id="usuarioInfo">Cargando informaciÃ³n...</p>
      <p>Ãšltima actualizaciÃ³n: <span id="ultima-actualizacion">--:--:--</span></p>
      <div class="buttons-container">
        <button class="btn btn-primary" onclick="window.location.href='/historial.html'">
          ğŸ“œ Ver Historial
        </button>
        <button class="btn btn-secondary" id="logoutBtn">
          ğŸšª Cerrar SesiÃ³n
        </button>
      </div>
    </div>

    <!-- Grid de sensores en tiempo real -->
    <div class="sensor-grid">
      <!-- Temperatura -->
      <div class="sensor-card temp-card" id="card-temperatura">
        <div class="sensor-icon">ğŸŒ¡ï¸</div>
        <div class="sensor-label">Temperatura</div>
        <div class="sensor-status" id="status-temperatura">â³ Esperando...</div>
        <div class="sensor-value" id="temperatura-valor">--</div>
        <div class="sensor-unit">Â°C</div>
        <div class="sensor-range">Normal: 36.0 - 37.5Â°C</div>
      </div>

      <!-- Frecuencia CardÃ­aca -->
      <div class="sensor-card ecg-card" id="card-pulso">
        <div class="sensor-icon">ğŸ’“</div>
        <div class="sensor-label">Frecuencia CardÃ­aca</div>
        <div class="sensor-status" id="status-pulso">â³ Esperando...</div>
        <div class="sensor-value" id="pulso-valor">--</div>
        <div class="sensor-unit">BPM</div>
        <div class="sensor-range">Normal: 60 - 100 BPM</div>
      </div>

      <!-- SpO2 -->
      <div class="sensor-card spo2-card" id="card-spo2">
        <div class="sensor-icon">ğŸ«</div>
        <div class="sensor-label">SaturaciÃ³n de OxÃ­geno</div>
        <div class="sensor-status" id="status-spo2">â³ Esperando...</div>
        <div class="sensor-value" id="spo2-valor">--</div>
        <div class="sensor-unit">%</div>
        <div class="sensor-range">Normal: â‰¥ 95%</div>
      </div>
    </div>

    <!-- SecciÃ³n de alertas -->
    <div id="alertas-container" class="alertas-section">
      <h3>âš ï¸ Alertas Activas</h3>
      <div id="alertas-lista" class="alertas-lista"></div>
    </div>

    <!-- Estado de dispositivos -->
    <div class="dispositivos-section">
      <h3>ğŸ“± Estado de Dispositivos</h3>
      <div class="dispositivos-lista">
        <div class="dispositivo-item">
          <span class="dispositivo-icon">ğŸŒ¡ï¸</span>
          <span class="dispositivo-name">Sensor de Temperatura</span>
          <span id="dispositivo-status-temperatura" class="status-badge status-disconnected">ğŸ”´ Desconectado</span>
        </div>
        <div class="dispositivo-item">
          <span class="dispositivo-icon">ğŸ’“</span>
          <span class="dispositivo-name">Sensor de Pulso</span>
          <span id="dispositivo-status-pulso" class="status-badge status-disconnected">ğŸ”´ Desconectado</span>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ==================== WEBSOCKET CONNECTION ====================
    let ws = null;
    let reconnectInterval = null;
    let isManualDisconnect = false;

    // Conectar WebSocket
    function conectarWebSocket() {
      const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      const wsUrl = `${wsProtocol}//${window.location.host}/ws`;
      
      console.log('ğŸ”Œ Conectando a WebSocket:', wsUrl);
      
      try {
        ws = new WebSocket(wsUrl);
        
        ws.onopen = () => {
          console.log('âœ… WebSocket conectado');
          updateConnectionStatus('connected');
          
          // ENVIAR TOKEN AL SERVIDOR
          const authToken = localStorage.getItem('authToken');
          
          if (authToken) {
            ws.send(JSON.stringify({
              type: 'web-client',
              token: authToken
            }));
            console.log('ğŸ“¡ Token enviado al servidor');
          } else {
            console.warn('âš ï¸ No hay token - conectado sin autenticaciÃ³n');
            ws.send(JSON.stringify({
              type: 'web-client'
            }));
          }
          
          if (reconnectInterval) {
            clearInterval(reconnectInterval);
            reconnectInterval = null;
          }
        };
        
        ws.onmessage = (event) => {
          try {
            const data = JSON.parse(event.data);
            console.log('ğŸ“¨ Mensaje recibido:', data);
            
            switch(data.type) {
              case 'sensor-data':
                actualizarDatos(data);
                verificarAlertas(data);
                break;
                
              case 'device-status':
                actualizarEstadoDispositivo(data);
                break;
                
              case 'devices-status':
                actualizarEstadosIniciales(data);
                break;
                
              default:
                console.log('Tipo de mensaje desconocido:', data.type);
            }
          } catch (error) {
            console.error('âŒ Error al procesar mensaje:', error);
          }
        };
        
        ws.onerror = (error) => {
          console.error('âŒ Error WebSocket:', error);
          updateConnectionStatus('error');
        };
        
        ws.onclose = (event) => {
          console.log('ğŸ“´ WebSocket cerrado:', event.code, event.reason);
          updateConnectionStatus('disconnected');
          
          if (!isManualDisconnect) {
            console.log('ğŸ”„ Intentando reconectar en 5 segundos...');
            if (!reconnectInterval) {
              reconnectInterval = setInterval(() => {
                console.log('ğŸ”„ Reconectando...');
                conectarWebSocket();
              }, 5000);
            }
          }
        };
        
      } catch (error) {
        console.error('âŒ Error al crear WebSocket:', error);
        updateConnectionStatus('error');
      }
    }

    // Desconectar WebSocket
    function desconectarWebSocket() {
      isManualDisconnect = true;
      
      if (reconnectInterval) {
        clearInterval(reconnectInterval);
        reconnectInterval = null;
      }
      
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.close();
        ws = null;
      }
      
      updateConnectionStatus('disconnected');
      console.log('ğŸ”´ WebSocket desconectado manualmente');
    }

    // Actualizar datos en la interfaz
    function actualizarDatos(data) {
      // Temperatura
      if (data.temperatura !== undefined && data.temperatura !== null) {
        const tempElement = document.getElementById('temperatura-valor');
        if (tempElement) {
          tempElement.textContent = data.temperatura.toFixed(1);
          
          const tempCard = document.getElementById('card-temperatura');
          if (tempCard) {
            tempCard.classList.remove('alerta-alta', 'alerta-baja');
            if (data.temperatura > 37.5) {
              tempCard.classList.add('alerta-alta');
            } else if (data.temperatura < 36) {
              tempCard.classList.add('alerta-baja');
            }
          }
        }
      }
      
      // Frecuencia CardÃ­aca
      if (data.pulso !== undefined && data.pulso !== null) {
        const pulsoElement = document.getElementById('pulso-valor');
        if (pulsoElement) {
          pulsoElement.textContent = Math.round(data.pulso);
          
          const pulsoCard = document.getElementById('card-pulso');
          if (pulsoCard) {
            pulsoCard.classList.remove('alerta-alta', 'alerta-baja');
            if (data.pulso > 100) {
              pulsoCard.classList.add('alerta-alta');
            } else if (data.pulso < 60 && data.pulso > 0) {
              pulsoCard.classList.add('alerta-baja');
            }
          }
        }
      }
      
      // SpO2
      if (data.spo2 !== undefined && data.spo2 !== null) {
        const spo2Element = document.getElementById('spo2-valor');
        if (spo2Element) {
          spo2Element.textContent = Math.round(data.spo2);
          
          const spo2Card = document.getElementById('card-spo2');
          if (spo2Card) {
            spo2Card.classList.remove('alerta-baja');
            if (data.spo2 < 95 && data.spo2 > 0) {
              spo2Card.classList.add('alerta-baja');
            }
          }
        }
      }
      
      // Actualizar timestamp
      const timestampElement = document.getElementById('ultima-actualizacion');
      if (timestampElement) {
        const now = new Date();
        timestampElement.textContent = now.toLocaleTimeString('es-ES');
      }
    }

    // Verificar y mostrar alertas
    function verificarAlertas(data) {
      const alertas = [];
      
      if (data.temperatura > 37.5) {
        alertas.push('ğŸ”¥ Temperatura elevada: ' + data.temperatura.toFixed(1) + 'Â°C');
      }
      if (data.temperatura < 36 && data.temperatura > 0) {
        alertas.push('â„ï¸ Temperatura baja: ' + data.temperatura.toFixed(1) + 'Â°C');
      }
      if (data.pulso > 100) {
        alertas.push('âš ï¸ Taquicardia: ' + Math.round(data.pulso) + ' BPM');
      }
      if (data.pulso < 60 && data.pulso > 0) {
        alertas.push('âš ï¸ Bradicardia: ' + Math.round(data.pulso) + ' BPM');
      }
      if (data.spo2 < 95 && data.spo2 > 0) {
        alertas.push('ğŸš¨ SpO2 bajo: ' + Math.round(data.spo2) + '%');
      }
      
      const alertasContainer = document.getElementById('alertas-container');
      const alertasLista = document.getElementById('alertas-lista');
      
      if (alertas.length > 0) {
        alertasContainer.style.display = 'block';
        alertasLista.innerHTML = alertas.map(alerta => 
          '<div class="alerta-item">' + alerta + '</div>'
        ).join('');
      } else {
        alertasContainer.style.display = 'none';
      }
    }

    // Actualizar estado de dispositivo individual
    function actualizarEstadoDispositivo(data) {
      console.log('ğŸ“Š Estado dispositivo:', data);
      
      const statusElement = document.getElementById('status-' + data.device);
      const dispositivoStatusElement = document.getElementById('dispositivo-status-' + data.device);
      
      if (statusElement) {
        if (data.status === 'connected') {
          statusElement.textContent = 'ğŸŸ¢ Conectado';
          statusElement.className = 'sensor-status status-connected';
        } else {
          statusElement.textContent = 'ğŸ”´ Desconectado';
          statusElement.className = 'sensor-status status-disconnected';
        }
      }
      
      if (dispositivoStatusElement) {
        if (data.status === 'connected') {
          dispositivoStatusElement.textContent = 'ğŸŸ¢ Conectado';
          dispositivoStatusElement.className = 'status-badge status-connected';
        } else {
          dispositivoStatusElement.textContent = 'ğŸ”´ Desconectado';
          dispositivoStatusElement.className = 'status-badge status-disconnected';
        }
      }
    }

    // Actualizar estados iniciales
    function actualizarEstadosIniciales(data) {
      console.log('ğŸ“Š Estados iniciales:', data);
      
      // Temperatura
      const tempStatus = document.getElementById('status-temperatura');
      const dispositivoTempStatus = document.getElementById('dispositivo-status-temperatura');
      
      if (tempStatus) {
        if (data.temperatura === 'connected') {
          tempStatus.textContent = 'ğŸŸ¢ Conectado';
          tempStatus.className = 'sensor-status status-connected';
        } else {
          tempStatus.textContent = 'ğŸ”´ Desconectado';
          tempStatus.className = 'sensor-status status-disconnected';
        }
      }
      
      if (dispositivoTempStatus) {
        if (data.temperatura === 'connected') {
          dispositivoTempStatus.textContent = 'ğŸŸ¢ Conectado';
          dispositivoTempStatus.className = 'status-badge status-connected';
        } else {
          dispositivoTempStatus.textContent = 'ğŸ”´ Desconectado';
          dispositivoTempStatus.className = 'status-badge status-disconnected';
        }
      }
      
      // Pulso
      const pulsoStatus = document.getElementById('status-pulso');
      const dispositivoPulsoStatus = document.getElementById('dispositivo-status-pulso');
      
      if (pulsoStatus) {
        if (data.pulso === 'connected') {
          pulsoStatus.textContent = 'ğŸŸ¢ Conectado';
          pulsoStatus.className = 'sensor-status status-connected';
        } else {
          pulsoStatus.textContent = 'ğŸ”´ Desconectado';
          pulsoStatus.className = 'sensor-status status-disconnected';
        }
      }
      
      if (dispositivoPulsoStatus) {
        if (data.pulso === 'connected') {
          dispositivoPulsoStatus.textContent = 'ğŸŸ¢ Conectado';
          dispositivoPulsoStatus.className = 'status-badge status-connected';
        } else {
          dispositivoPulsoStatus.textContent = 'ğŸ”´ Desconectado';
          dispositivoPulsoStatus.className = 'status-badge status-disconnected';
        }
      }
    }

    // Actualizar indicador de conexiÃ³n
    function updateConnectionStatus(status) {
      const statusElement = document.getElementById('connection-status');
      if (!statusElement) return;
      
      statusElement.className = 'connection-status';
      
      switch(status) {
        case 'connected':
          statusElement.textContent = 'ğŸŸ¢ Conectado';
          statusElement.classList.add('status-connected');
          break;
          
        case 'disconnected':
          statusElement.textContent = 'ğŸ”´ Desconectado';
          statusElement.classList.add('status-disconnected');
          break;
          
        case 'error':
          statusElement.textContent = 'âš ï¸ Error';
          statusElement.classList.add('status-error');
          break;
          
        default:
          statusElement.textContent = 'â³ Conectando...';
          statusElement.classList.add('status-connecting');
      }
    }

    // INICIALIZACIÃ“N
    window.addEventListener('DOMContentLoaded', function() {
      console.log('ğŸš€ Inicializando aplicaciÃ³n...');
      
      const authToken = localStorage.getItem('authToken');
      const usuarioStr = localStorage.getItem('usuario');
      
      if (!authToken || !usuarioStr) {
        console.log('âŒ No hay sesiÃ³n - redirigiendo a login');
        window.location.replace('/login.html');
        return;
      }
      
      try {
        const usuario = JSON.parse(usuarioStr);
        const usuarioInfoElement = document.getElementById('usuarioInfo');
        if (usuarioInfoElement) {
          usuarioInfoElement.textContent = 'Usuario: ' + (usuario.full_name || usuario.username);
        }
        console.log('âœ… Usuario cargado:', usuario.username);
      } catch (error) {
        console.error('âŒ Error al cargar usuario:', error);
      }
      
      conectarWebSocket();
      
      const logoutBtn = document.getElementById('logoutBtn');
      if (logoutBtn) {
        logoutBtn.addEventListener('click', function() {
          desconectarWebSocket();
          localStorage.removeItem('authToken');
          localStorage.removeItem('usuario');
          window.location.replace('/login.html');
        });
      }
    });

    window.addEventListener('beforeunload', function() {
      desconectarWebSocket();
    });
  </script>
</body>
</html>